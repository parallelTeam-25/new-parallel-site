name: Deploy to Hostinger via API

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Create deployment package
      run: |
        # Crea un archivio con tutti i file necessari
        tar -czf deployment.tar.gz \
          --exclude='.git' \
          --exclude='.github' \
          --exclude='README.md' \
          --exclude='.gitignore' \
          --exclude='deployment.tar.gz' \
          .
        echo "Package created: $(ls -lh deployment.tar.gz)"
    
    - name: Deploy via Hostinger File Manager API
      uses: wei/curl@master
      with:
        args: |
          -X POST \
          -H "Content-Type: multipart/form-data" \
          -F "file=@deployment.tar.gz" \
          -F "host=195.35.27.36" \
          -F "username=u399412635.parallel-ai.it" \
          -F "password=y*xr=lgC!LM*J9n" \
          -F "path=public_html" \
          -F "extract=true" \
          https://api.hostinger.com/v1/deploy || true
    
    - name: Alternative FTP with different method
      run: |
        # Installa ncftp (più affidabile di lftp per Hostinger)
        sudo apt-get update
        sudo apt-get install -y ncftp
        
        # Crea script ncftp
        cat > deploy_script.ftp << 'EOF'
        open -u u399412635.parallel-ai.it -p y*xr=lgC!LM*J9n 195.35.27.36
        cd public_html
        lcd .
        put -R * 
        quit
        EOF
        
        # Esegui con timeout
        timeout 600 ncftp < deploy_script.ftp || echo "Deploy completed or timed out"
    
    - name: Verify deployment with curl
      run: |
        sleep 30
        echo "Checking if site is updated..."
        curl -I http://parallel-ai.it/ || echo "Site check completed"
        
    - name: Fallback notification
      if: failure()
      run: |
        echo "❌ Automatic deploy failed"
        echo "📁 Manual deploy option:"
        echo "   1. Download: https://github.com/${{ github.repository }}/archive/${{ github.sha }}.zip"
        echo "   2. Extract and upload to Hostinger public_html/"
        echo "   3. Done!"